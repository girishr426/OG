{% extends 'base.html' %}
{% block content %}
<!-- Hero Section with Auto-Scrolling Image Carousel - Only show on homepage (root page, no region/status filters) -->
{% if request.endpoint == 'index' and not session.get('region_id') and not session.get('product_status') %}
<section class="hero-section">
  {% if catalog_images.get('hero') and catalog_images['hero']|length > 0 %}
  <!-- Carousel with Real Catalog Images -->
  <div class="hero-carousel" id="heroCarousel">
    <div class="carousel-container">
      <div class="carousel-track" id="carouselTrack">
        {% for img in catalog_images['hero'] %}
        <div class="carousel-slide">
          <img src="{{ url_for('static', filename=img.path) }}" alt="{{ img.alt }}" class="carousel-image" loading="lazy" decoding="async">
          <div class="carousel-overlay"></div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Carousel Indicators (Dots Navigation) - Show only if more than 1 image -->
    {% if catalog_images['hero']|length > 1 %}
    <div class="carousel-indicators" id="indicators">
      {% for img in catalog_images['hero'] %}
      <button class="indicator {% if loop.first %}active{% endif %}" data-index="{{ loop.index0 }}" aria-label="Go to slide {{ loop.index }}">‚óè</button>
      {% endfor %}
    </div>
    {% endif %}
    
  </div>
  
  <!-- Hero Carousel JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const carousel = document.getElementById('heroCarousel');
      const track = document.getElementById('carouselTrack');
      const indicators = document.querySelectorAll('.indicator');
      
      if (!carousel || !track) return;
      
      const totalSlides = {{ catalog_images['hero']|length }};
      let currentIndex = 0;
      let autoScrollInterval;
      
      // Update carousel position
      function updateCarousel() {
        const offset = -currentIndex * 100;
        track.style.transform = `translateX(${offset}%)`;
        
        // Update indicators
        indicators.forEach((indicator, idx) => {
          indicator.classList.toggle('active', idx === currentIndex);
        });
      }
      
      // Go to specific slide
      function goToSlide(index) {
        currentIndex = (index + totalSlides) % totalSlides;
        updateCarousel();
        resetAutoScroll();
      }
      
      // Next slide
      function nextSlide() {
        goToSlide(currentIndex + 1);
      }
      
      // Previous slide
      function prevSlide() {
        goToSlide(currentIndex - 1);
      }
      
      // Auto scroll function
      function startAutoScroll() {
        autoScrollInterval = setInterval(nextSlide, 5000); // Change slide every 5 seconds
      }
      
      // Reset auto scroll timer
      function resetAutoScroll() {
        clearInterval(autoScrollInterval);
        startAutoScroll();
      }
      
      // Event listeners for indicators
      indicators.forEach((indicator, idx) => {
        indicator.addEventListener('click', () => goToSlide(idx));
      });
      
      // Stop auto-scroll on hover, resume on mouse leave
      carousel.addEventListener('mouseenter', () => {
        clearInterval(autoScrollInterval);
      });
      
      carousel.addEventListener('mouseleave', () => {
        startAutoScroll();
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!carousel.matches(':hover')) return;
        if (e.key === 'ArrowLeft') prevSlide();
        if (e.key === 'ArrowRight') nextSlide();
      });
      
      // Initialize
      updateCarousel();
      startAutoScroll();
    });
  </script>
  {% else %}
  <!-- Fallback Hero Section with Illustrations -->
  <div class="hero-container">
    <!-- Left: Farmer Image -->
    <div class="hero-image-wrapper hero-left">
      <div class="hero-image-placeholder farmer-image">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <!-- Farmer illustration -->
          <circle cx="100" cy="50" r="20" fill="#8b6f47"/>
          <rect x="80" y="70" width="40" height="50" fill="#4a7c59" rx="5"/>
          <rect x="70" y="120" width="15" height="40" fill="#d4a574" rx="3"/>
          <rect x="115" y="120" width="15" height="40" fill="#d4a574" rx="3"/>
          <circle cx="77.5" cy="160" r="8" fill="#8b6f47"/>
          <circle cx="122.5" cy="160" r="8" fill="#8b6f47"/>
          <!-- Hat -->
          <ellipse cx="100" cy="35" rx="25" ry="8" fill="#654321"/>
          <path d="M 75 35 L 70 25 L 130 25 L 125 35" fill="#8b4513"/>
          <!-- Basket of vegetables -->
          <path d="M 40 140 L 35 180 L 65 180 L 60 140" fill="#a0826d" stroke="#654321" stroke-width="1"/>
          <circle cx="45" cy="160" r="4" fill="#ff6b6b"/>
          <circle cx="55" cy="165" r="4" fill="#ffd93d"/>
          <circle cx="50" cy="170" r="4" fill="#2ecc71"/>
        </svg>
        <p class="hero-label">Fresh from Farmers</p>
      </div>
    </div>

    <!-- Center: Main Message -->
    <div class="hero-message">
      <h1 style="color: #1f6feb; font-size: 2.5rem; margin: 0 0 1rem 0;">üå± Organic Gut Point</h1>
      <p style="font-size: 1.2rem; color: #555; margin: 0.5rem 0; font-weight: 500;">Direct from Farmers to Your Table</p>
      <p style="font-size: 1rem; color: #777; margin: 1rem 0;">100% Genuine Organic Products ‚Ä¢ Know What Your Gut Sips</p>
    </div>

    <!-- Right: Customer Image -->
    <div class="hero-image-wrapper hero-right">
      <div class="hero-image-placeholder customer-image">
        <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <!-- Customer illustration -->
          <circle cx="100" cy="50" r="20" fill="#d4a574"/>
          <path d="M 80 70 Q 80 60 100 60 Q 120 60 120 70 L 120 100 Q 120 110 100 115 Q 80 110 80 100 Z" fill="#ff69b4" stroke="#f78ca0" stroke-width="1"/>
          <rect x="50" y="100" width="20" height="50" fill="#d4a574" rx="3"/>
          <rect x="130" y="100" width="20" height="50" fill="#d4a574" rx="3"/>
          <rect x="65" y="150" width="18" height="40" fill="#4a5568" rx="3"/>
          <rect x="117" y="150" width="18" height="40" fill="#4a5568" rx="3"/>
          <circle cx="74" cy="190" r="6" fill="#2d3748"/>
          <circle cx="126" cy="190" r="6" fill="#2d3748"/>
          <!-- Smile -->
          <circle cx="95" cy="50" r="2" fill="#000"/>
          <circle cx="105" cy="50" r="2" fill="#000"/>
          <path d="M 95 55 Q 100 58 105 55" stroke="#000" stroke-width="1" fill="none"/>
          <!-- Shopping basket -->
          <path d="M 30 140 L 25 180 L 55 180 L 50 140" fill="#8b6f47" stroke="#654321" stroke-width="1"/>
          <path d="M 35 145 L 50 145" stroke="#654321" stroke-width="1"/>
          <circle cx="35" cy="165" r="3" fill="#2ecc71"/>
          <circle cx="42" cy="168" r="3" fill="#ff6b6b"/>
          <circle cx="48" cy="164" r="3" fill="#ffd93d"/>
        </svg>
        <p class="hero-label">Happy Customers</p>
      </div>
    </div>
  </div>
  {% endif %}
</section>
{% endif %}

<!-- Left Side Placeholder Image -->
<!-- Left Catalog Images - Fixed Position on Left Edge, Below Nav -->
{% if catalog_images.get('left') and catalog_images['left']|length > 0 %}
<div class="catalog-sidebar-left">
  <div class="catalog-track">
    {% for img in catalog_images['left'] %}
    <img src="{{ url_for('static', filename=img.path) }}" alt="{{ img.alt }}" class="catalog-img" loading="lazy" decoding="async">
    {% endfor %}
    <!-- Duplicate images for seamless infinite loop -->
    {% for img in catalog_images['left'] %}
    <img src="{{ url_for('static', filename=img.path) }}" alt="{{ img.alt }}" class="catalog-img" loading="lazy" decoding="async">
    {% endfor %}
  </div>
  </div>
{% endif %}

<!-- Right Catalog Images - Fixed Position on Right Edge, Below Nav -->
{% if catalog_images.get('right') and catalog_images['right']|length > 0 %}
<div class="catalog-sidebar-right">
  <div class="catalog-track">
    {% for img in catalog_images['right'] %}
    <img src="{{ url_for('static', filename=img.path) }}" alt="{{ img.alt }}" class="catalog-img" loading="lazy" decoding="async">
    {% endfor %}
    <!-- Duplicate images for seamless infinite loop -->
    {% for img in catalog_images['right'] %}
    <img src="{{ url_for('static', filename=img.path) }}" alt="{{ img.alt }}" class="catalog-img" loading="lazy" decoding="async">
    {% endfor %}
  </div>
  </div>
{% endif %}

<!-- Trust Badges - Independent of image margins -->
<section class="trust-badges" style="position: relative; z-index: 2;">
  <div class="badge">‚úÖ 100% Genuine & Organic</div>
  <div class="badge">üçµ Know What Your Gut Sips</div>
  <div class="badge">üîí Secure Payments</div>
  <div class="badge">üì¶ Easy Returns</div>
  <div class="badge">‚ù§Ô∏è Trust & Transparency</div>
  <div class="badge">üìû 24x7 Support</div>
</section>

<div style="position: relative;">

<h2 style="margin: 1rem 0;">{{ title }}</h2>

<!-- Product Count & Sort -->
<div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.75rem; margin-bottom:1rem;">
  {% if total_products %}
  <div class="pagination-info">
    Showing <strong>{{ ((current_page - 1) * 12) + 1 }}-{{ [current_page * 12, total_products] | min }}</strong> of <strong>{{ total_products }}</strong> products
  </div>
  {% endif %}
  <!-- Sort by - Only show on homepage -->
  {% if is_homepage %}
  <form method="get" action="{{ url_for('index') }}" style="display:flex; align-items:center; gap:0.5rem;">
    <label for="sort" style="color:#666; white-space:nowrap;">Sort by:</label>
    <select id="sort" name="sort" onchange="this.form.submit()" style="padding:0.4rem 0.6rem; border:1px solid #ddd; border-radius:6px;">
      <option value="new" {% if sort=='new' %}selected{% endif %}>Newest</option>
      <option value="price_low" {% if sort=='price_low' %}selected{% endif %}>Price: Low to High</option>
      <option value="price_high" {% if sort=='price_high' %}selected{% endif %}>Price: High to Low</option>
      <option value="name_az" {% if sort=='name_az' %}selected{% endif %}>Name: A ‚Üí Z</option>
    </select>
  </form>
  {% endif %}
</div>

<div class="grid">
  {% for p in products %}
  <div class="card">
    <!-- Product Image -->
    {% if p.image_path %}
    <div class="product-img-wrapper">
      <a href="{{ url_for('product_detail', pid=p.id) }}">
        <img src="{{ url_for('static', filename=p.image_path) }}" alt="{{ p.name }}" class="product-image" loading="lazy" decoding="async">
      </a>
      {% if p.id in new_product_ids %}
      <span class="new-badge">New</span>
      {% endif %}
      {% if p.mrp is not none and p.mrp > p.price %}
      {% set pct = ((p.mrp - p.price) / p.mrp * 100) | round(0, 'floor') %}
      <span class="discount-badge">{{ pct|int }}% OFF</span>
      {% endif %}
    </div>
    {% endif %}
    
    <!-- Product Name (Minimal) -->
    <h3 style="margin: 0.5rem 0; font-size: 0.95rem; font-weight: 600; line-height: 1.3;">
      <a href="{{ url_for('product_detail', pid=p.id) }}" style="text-decoration: none; color: #333;">{{ p.name }}</a>
    </h3>
    
    <!-- Product Size (Minimal) -->
    {% if p.size and p.size != 'Standard' %}
    <p style="margin: 0.2rem 0; font-size: 0.85rem; color: #666;">{{ p.size }}</p>
    {% endif %}
    
    <!-- Price (Minimal) -->
    {% if p.mrp is not none and p.mrp > p.price %}
      <p style="margin: 0.3rem 0; font-size: 0.9rem;">
        <span style="color: #4CAF50; font-weight: 700; font-size: 1rem;">‚Çπ{{ '%.0f'|format(p.price) }}</span>
        <span style="color: #999; text-decoration: line-through; font-size: 0.85rem; margin-left: 0.3rem;">‚Çπ{{ '%.0f'|format(p.mrp) }}</span>
      </p>
    {% else %}
      <p style="margin: 0.3rem 0; font-size: 1rem; font-weight: 700; color: #333;">‚Çπ{{ '%.0f'|format(p.price) }}</p>
    {% endif %}
    
    <!-- Add to Cart Button -->
    <form action="{{ url_for('add_to_cart', pid=p.id) }}" method="get" style="margin-top: 0.5rem;">
      <button style="width: 100%; padding: 0.5rem; font-size: 0.85rem; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;" 
              {% if p.stock <= 0 %}disabled style="background: #ccc; cursor: not-allowed;" title="Out of Stock"{% endif %}>
        {{ 'Add to Cart' if p.stock > 0 else 'Out of Stock' }}
      </button>
    </form>
  </div>
  {% endfor %}
</div>

<!-- Pagination Controls -->
{% if total_pages and total_pages > 1 %}
<nav class="pagination">
  <!-- Previous Button -->
  {% if current_page > 1 %}
  <a href="{% if is_search_result %}{{ url_for('search', q=search_query, sort=sort, page=current_page - 1) }}{% else %}{{ url_for('index', sort=sort, page=current_page - 1) }}{% endif %}" class="pagination-btn pagination-prev">‚Üê Previous</a>
  {% else %}
    <span class="pagination-btn pagination-prev disabled">‚Üê Previous</span>
  {% endif %}

  <!-- Page Numbers -->
  <div class="pagination-pages">
    {% set start_page = [1, current_page - 2] | max %}
    {% set end_page = [total_pages, current_page + 2] | min %}
    
    <!-- First page link if not in range -->
    {% if start_page > 1 %}
  <a href="{% if is_search_result %}{{ url_for('search', q=search_query, sort=sort, page=1) }}{% else %}{{ url_for('index', sort=sort, page=1) }}{% endif %}" class="pagination-number">1</a>
      {% if start_page > 2 %}<span class="pagination-dots">...</span>{% endif %}
    {% endif %}

    <!-- Page links in range -->
    {% for page_num in range(start_page, end_page + 1) %}
      {% if page_num == current_page %}
        <span class="pagination-number active">{{ page_num }}</span>
      {% else %}
  <a href="{% if is_search_result %}{{ url_for('search', q=search_query, sort=sort, page=page_num) }}{% else %}{{ url_for('index', sort=sort, page=page_num) }}{% endif %}" class="pagination-number">{{ page_num }}</a>
      {% endif %}
    {% endfor %}

    <!-- Last page link if not in range -->
    {% if end_page < total_pages %}
      {% if end_page < total_pages - 1 %}<span class="pagination-dots">...</span>{% endif %}
  <a href="{% if is_search_result %}{{ url_for('search', q=search_query, sort=sort, page=total_pages) }}{% else %}{{ url_for('index', sort=sort, page=total_pages) }}{% endif %}" class="pagination-number">{{ total_pages }}</a>
    {% endif %}
  </div>

  <!-- Next Button -->
  {% if current_page < total_pages %}
  <a href="{% if is_search_result %}{{ url_for('search', q=search_query, sort=sort, page=current_page + 1) }}{% else %}{{ url_for('index', sort=sort, page=current_page + 1) }}{% endif %}" class="pagination-btn pagination-next">Next ‚Üí</a>
  {% else %}
    <span class="pagination-btn pagination-next disabled">Next ‚Üí</span>
  {% endif %}
</nav>
{% endif %}

</div>

<!-- Gut Care Products Carousel Section (Only on Homepage with Newest sort) -->
{% if gutcare_carousel_products and is_homepage and sort == 'new' %}
<section style="margin-top: 3rem; padding: 2rem 1rem; background: linear-gradient(135deg, rgba(139, 69, 19, 0.03) 0%, rgba(210, 180, 140, 0.02) 100%);">
  <!-- Section Header -->
  <div style="text-align: center; margin-bottom: 2rem;">
    <h2 style="margin: 0 0 0.5rem 0; font-size: 1.8rem; color: #1a1a1a; font-weight: 700;">üåø Gut Care & Wellness</h2>
    <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.95rem;">Premium products for digestive health</p>
  </div>

  <!-- Horizontal Scrolling Carousel -->
  <div style="position: relative; margin: 0 -1rem;">
    <!-- Scroll Container -->
    <div style="overflow-x: auto; scroll-behavior: smooth; padding: 0 1rem; scrollbar-width: thin;" id="gutcareScroll">
      <div style="display: flex; gap: 1.2rem; min-width: min-content; padding: 0;">
        {% for product in gutcare_carousel_products %}
        <!-- Product Card -->
        <a href="{{ url_for('product_detail', pid=product.id) }}" 
           style="flex: 0 0 200px; text-decoration: none; color: inherit; display: flex; flex-direction: column; background: white; border-radius: 12px; border: 1px solid #f0f0f0; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease;">
          
          <!-- Product Image -->
          <div style="width: 100%; height: 200px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden;">
            {% if product.image_path %}
            <img src="{{ url_for('static', filename=product.image_path) }}" alt="{{ product.name }}" 
                 style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
            <div style="font-size: 3rem; color: #ddd;">üå±</div>
            {% endif %}
          </div>

          <!-- Product Info -->
          <div style="padding: 1rem; flex: 1; display: flex; flex-direction: column;">
            <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #1a1a1a; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ product.name }}</p>
            {% if product.size and product.size != 'Standard' %}
            <p style="margin: 0 0 0.3rem 0; font-size: 0.8rem; color: #666;">{{ product.size }}</p>
            {% endif %}
            <p style="margin: 0; color: #2ea043; font-weight: 700; font-size: 1rem;">‚Çπ{{ '%.0f'|format(product.price) }}</p>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>

    <!-- Scroll Navigation Buttons -->
    <button onclick="document.getElementById('gutcareScroll').scrollBy({left: -300, behavior: 'smooth'})" 
            style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: #1f6f2f; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #ffffff; z-index: 10; box-shadow: 0 2px 8px rgba(31, 111, 47, 0.3); transition: all 0.2s ease; font-weight: bold; line-height: 1;"
            onmouseover="this.style.boxShadow='0 4px 12px rgba(31, 111, 47, 0.5)'"
            onmouseout="this.style.boxShadow='0 2px 8px rgba(31, 111, 47, 0.3)'"
            aria-label="Scroll left">
      &lt;
    </button>

    <button onclick="document.getElementById('gutcareScroll').scrollBy({left: 300, behavior: 'smooth'})" 
            style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: #1f6f2f; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #ffffff; z-index: 10; box-shadow: 0 2px 8px rgba(31, 111, 47, 0.3); transition: all 0.2s ease; font-weight: bold; line-height: 1;"
            onmouseover="this.style.boxShadow='0 4px 12px rgba(31, 111, 47, 0.5)'"
            onmouseout="this.style.boxShadow='0 2px 8px rgba(31, 111, 47, 0.3)'"
            aria-label="Scroll right">
      &gt;
    </button>
  </div>

  <!-- View All Gut Care Products Link -->
  <div style="text-align: center; margin-top: 1.5rem;">
    <a href="{{ url_for('category_view', category='gutcare') }}" 
       style="display: inline-block; padding: 0.8rem 1.5rem; background: #1f6f2f; color: #ffffff; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 0.95rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(31, 111, 47, 0.3);">
      View All Gut Care Products ‚Üí
    </a>
  </div>
</section>
{% endif %}

<!-- Carousel Control Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const carouselTrack = document.getElementById('carouselTrack');
  const indicators = document.querySelectorAll('.indicator');
  
  if (!carouselTrack || indicators.length === 0) return; // No carousel to control
  
  let currentIndex = 0;
  const slideCount = indicators.length;
  let autoScrollInterval;
  
  // Update active indicator
  function updateIndicators() {
    indicators.forEach((ind, idx) => {
      ind.classList.toggle('active', idx === currentIndex % slideCount);
    });
  }
  
  // Move to specific slide
  function goToSlide(index) {
    currentIndex = index;
    const offset = -(currentIndex * 100);
    carouselTrack.style.animation = 'none';
    carouselTrack.style.transform = `translateX(${offset}%)`;
    updateIndicators();
    resetAutoScroll();
  }
  
  // Next slide
  function nextSlide() {
    currentIndex = (currentIndex + 1) % slideCount;
    goToSlide(currentIndex);
  }
  
  // Auto-scroll functionality
  function startAutoScroll() {
    autoScrollInterval = setInterval(nextSlide, 5000); // Change slide every 5 seconds
  }
  
  function resetAutoScroll() {
    clearInterval(autoScrollInterval);
    startAutoScroll();
  }
  
  // Indicator click handlers (dots navigation)
  indicators.forEach((ind, idx) => {
    ind.addEventListener('click', () => goToSlide(idx));
  });
  
  // Pause on hover
  const carousel = document.querySelector('.hero-carousel');
  carousel.addEventListener('mouseenter', () => clearInterval(autoScrollInterval));
  carousel.addEventListener('mouseleave', resetAutoScroll);
  
  // Initialize
  updateIndicators();
  startAutoScroll();
});
</script>

{% endblock %}
