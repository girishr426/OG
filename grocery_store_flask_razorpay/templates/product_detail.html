{% extends 'base.html' %}
{% block content %}
<style>
  .product-detail-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    max-width: 1200px;
    margin: 2rem auto;
    padding: 1rem;
  }

  .product-gallery-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .gallery-main {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    background: #f5f5f5;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gallery-main img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .gallery-main img:hover {
    transform: scale(1.05);
  }

  .gallery-thumbnails {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding: 0.5rem 0;
  }

  .thumbnail {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.3s ease;
    flex-shrink: 0;
    background: #f5f5f5;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }

  .thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumbnail.active {
    border-color: #4CAF50;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
  }

  .thumbnail:hover {
    border-color: #ddd;
    opacity: 0.8;
  }

  .product-info-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .product-header {
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 1.5rem;
  }

  .product-title {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 0.5rem;
  }

  .product-status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 0.5rem;
    width: fit-content;
  }

  .status-upcoming {
    background: #c8e6c9;
    color: #1b5e20;
  }

  .status-harvest {
    background: #ffe0b2;
    color: #664d03;
  }

  .status-final {
    background: #b3e5fc;
    color: #01579b;
  }

  .product-price {
    font-size: 2.5rem;
    font-weight: 700;
    color: #4CAF50;
    margin: 1rem 0;
  }

  .price-note {
    font-size: 0.9rem;
    color: #666;
  }

  .product-meta {
    display: flex;
    gap: 2rem;
    padding: 1rem;
    background: #f9f9f9;
    border-radius: 8px;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .meta-label {
    font-size: 0.85rem;
    color: #999;
    font-weight: 600;
  }

  .meta-value {
    font-size: 1.1rem;
    color: #333;
    font-weight: 600;
  }

  .product-description {
    line-height: 1.8;
    color: #555;
    font-size: 1rem;
  }

  .product-description h3 {
    color: #333;
    margin: 1.5rem 0 0.5rem 0;
  }

  .product-description ul,
  .product-description ol {
    margin: 1rem 0 1rem 1.5rem;
  }

  .product-description li {
    margin-bottom: 0.5rem;
  }

  .product-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn {
    flex: 1;
    padding: 1rem;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-primary {
    background: #4CAF50;
    color: #000;
  }

  .btn-primary:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
  }

  .btn-secondary {
    background: #f0f0f0;
    color: #333;
    border: 1px solid #ddd;
  }

  .btn-secondary:hover {
    background: #e0e0e0;
  }

  .stock-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    padding: 0.75rem 1rem;
    background: #f0f0f0;
    border-radius: 8px;
  }

  .stock-available {
    color: #2e7d32;
    font-weight: 600;
  }

  .stock-low {
    color: #f57f17;
    font-weight: 600;
  }

  .stock-unavailable {
    color: #c62828;
    font-weight: 600;
  }

  .gallery-loading {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
  }

  .no-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: #ccc;
  }

  @media (max-width: 768px) {
    .product-detail-container {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .product-title {
      font-size: 1.5rem;
    }

    .product-price {
      font-size: 2rem;
    }

    .product-meta {
      flex-direction: column;
      gap: 1rem;
    }

    .product-actions {
      flex-direction: column;
    }

    .btn {
      width: 100%;
    }

    .gallery-thumbnails {
      gap: 0.25rem;
    }

    .thumbnail {
      width: 60px;
      height: 60px;
    }
  }
</style>

<div class="product-detail-container">
  <!-- Gallery Section -->
  <div class="product-gallery-section">
    <div class="gallery-main">
      {% if catalog_images %}
        <img 
          id="mainImage" 
          src="{{ url_for('static', filename=catalog_images[0].image_path) }}" 
          alt="{{ product.name }}" 
          loading="lazy"
        >
      {% elif product.image_path %}
        <img 
          id="mainImageFallback" 
          src="{{ url_for('static', filename=product.image_path) }}" 
          alt="{{ product.name }}" 
          loading="lazy"
        >
      {% else %}
        <div class="no-image-placeholder">üì¶</div>
      {% endif %}
    </div>

    <!-- Thumbnails -->
    {% if catalog_images %}
      <div class="gallery-thumbnails">
        {% for img in catalog_images %}
          <button 
            class="thumbnail {% if loop.index0 == 0 %}active{% endif %}" 
            onclick="updateMainImage(this)"
            data-src="{{ url_for('static', filename=img.image_path) }}"
            title="View gallery image {{ loop.index }}"
            aria-label="Gallery image {{ loop.index }}"
          >
            <img src="{{ url_for('static', filename=img.image_path) }}" alt="Gallery view">
          </button>
        {% endfor %}
      </div>
    {% elif product.image_path %}
      <div class="gallery-thumbnails">
        <div class="thumbnail active">
          <img src="{{ url_for('static', filename=product.image_path) }}" alt="{{ product.name }}">
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Product Info Section -->
  <div class="product-info-section">
    <div class="product-header">
      <h1 class="product-title">{{ product.name }}</h1>
      {% if product.product_status %}
        <span class="product-status-badge status-{% if product.product_status == 'Upcoming Harvest' %}upcoming{% elif product.product_status == 'Harvest Complete' %}harvest{% else %}final{% endif %}">
          {{ product.product_status }}
        </span>
      {% endif %}
    </div>

    <!-- Price -->
    <div>
      {% if product.mrp is not none and product.mrp > product.price %}
        {% set pct = ((product.mrp - product.price) / product.mrp * 100) | round(0, 'floor') %}
        <div style="display:flex; align-items:baseline; gap:0.6rem; flex-wrap:wrap;">
          <span class="product-price" style="margin:0;">‚Çπ{{ '%.2f'|format(product.price) }}</span>
          <span style="color:#999; text-decoration: line-through; font-size:1.25rem;">‚Çπ{{ '%.2f'|format(product.mrp) }}</span>
          <span style="background:#e6f4ea; color:#1b5e20; padding:0.2rem 0.6rem; border-radius: 16px; font-weight:700; font-size:0.9rem;">{{ pct|int }}% OFF</span>
        </div>
        <p class="price-note">You save ‚Çπ{{ '%.2f'|format(product.mrp - product.price) }} | Incl. all taxes | Free delivery</p>
      {% else %}
        <p class="product-price">‚Çπ{{ '%.2f'|format(product.price) }}</p>
        <p class="price-note">Incl. all taxes | Free delivery</p>
      {% endif %}
    </div>

    <!-- Meta Information -->
    <div class="product-meta">
      <div class="meta-item">
        <span class="meta-label">üì¶ In Stock</span>
        <span class="meta-value">{{ product.stock }} units</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">‚è±Ô∏è Delivery</span>
        <span class="meta-value">{{ est_date }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label">üåç Images</span>
        <span class="meta-value">{{ catalog_images|length if catalog_images else (1 if product.image_path else 0) }}</span>
      </div>
    </div>

    <!-- Stock Status -->
    <div class="stock-status">
      {% if product.stock > 10 %}
        <span class="stock-available">‚úì In Stock</span>
      {% elif product.stock > 0 %}
        <span class="stock-low">‚ö† Limited Stock</span>
      {% else %}
        <span class="stock-unavailable">‚úó Out of Stock</span>
      {% endif %}
    </div>

    <!-- Description -->
    <div class="product-description">
      {{ product.description|safe if product.description else 'No description available' }}
    </div>

    <!-- Actions -->
    <div class="product-actions">
      <form action="{{ url_for('add_to_cart', pid=product.id) }}" method="get" style="flex: 1;">
        <button type="submit" class="btn btn-primary" {% if product.stock <= 0 %}disabled{% endif %}>
          {% if product.stock > 0 %}
            üõí Add to Cart
          {% else %}
            Out of Stock
          {% endif %}
        </button>
      </form>
      <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Back to Products</a>
    </div>
  </div>
</div>

<!-- Reviews Section -->
<div style="max-width: 1200px; margin: 1rem auto 3rem auto; padding: 0 1rem;">
  <h2 style="font-size: 1.5rem; font-weight: 700; margin: 1rem 0;">Ratings & Reviews</h2>

  {% set stats = review_stats or {'avg_rating':0.0,'total':0,'breakdown':{5:0,4:0,3:0,2:0,1:0}} %}
  <div style="display: grid; grid-template-columns: 280px 1fr; gap: 2rem; align-items: start;">
    <!-- Summary -->
    <div style="border: 1px solid #eee; border-radius: 12px; padding: 1rem; background: #fafafa;">
      <div style="font-size: 2.5rem; font-weight: 800; color: #333;">{{ '%.1f'|format(stats.avg_rating or 0) }}</div>
      <div style="color:#f59e0b; font-size: 1.25rem;">
        {% for i in range(1,6) %}
          {% if i <= (stats.avg_rating or 0)|round(0, 'floor') %}‚òÖ{% else %}‚òÜ{% endif %}
        {% endfor %}
      </div>
      <div style="color:#666; margin-top: 0.25rem;">{{ stats.total }} ratings</div>
      <div style="margin-top:1rem;">
        {% for star in [5,4,3,2,1] %}
          {% set count = stats.breakdown.get(star, 0) %}
          {% set pct = (100.0 * count / (stats.total if stats.total else 1)) %}
          <div style="display:flex; align-items:center; gap:0.5rem; margin: 0.25rem 0;">
            <span style="width: 20px; font-weight: 700;">{{ star }}</span>
            <div style="flex:1; height: 8px; background:#eee; border-radius: 4px; overflow:hidden;">
              <div class="rating-bar-fill" data-pct="{{ pct|round(1) }}" style="width:0%; height: 100%; background: #4CAF50;"></div>
            </div>
            <span style="width:40px; text-align:right; color:#666; font-size: 0.9rem;">{{ count }}</span>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Reviews List -->
    <div>
      <form method="get" action="{{ url_for('product_detail', pid=product.id) }}" style="display:flex; gap:0.5rem; align-items:center; margin-bottom: 0.75rem;">
        <label for="sort" style="color:#666;">Sort by</label>
        <select name="sort" id="sort" onchange="this.form.submit()" style="padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
          <option value="helpful" {% if review_sort=='helpful' %}selected{% endif %}>Most Helpful</option>
          <option value="recent" {% if review_sort=='recent' %}selected{% endif %}>Most Recent</option>
          <option value="rating_high" {% if review_sort=='rating_high' %}selected{% endif %}>Highest Rating</option>
          <option value="rating_low" {% if review_sort=='rating_low' %}selected{% endif %}>Lowest Rating</option>
        </select>
      </form>

      {% if reviews and reviews|length > 0 %}
        <div style="display:flex; flex-direction:column; gap:1rem;">
          {% for r in reviews %}
            <div style="border: 1px solid #eee; border-radius: 12px; padding: 1rem;">
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <span style="color:#f59e0b;">
                  {% for i in range(1,6) %}
                    {% if i <= r.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                  {% endfor %}
                </span>
                {% if r.verified_purchase %}
                  <span style="background:#e8f5e9; color:#1b5e20; padding:2px 8px; border-radius:12px; font-size:0.8rem; font-weight:700;">Verified Purchase</span>
                {% endif %}
              </div>
              {% if r.title %}
                <div style="font-weight:700; margin-top:0.25rem;">{{ r.title }}</div>
              {% endif %}
              <div style="margin-top:0.25rem; line-height:1.6; color:#444; white-space:pre-wrap;">{{ r.body }}</div>
              <div style="display:flex; align-items:center; gap:0.75rem; margin-top:0.75rem; color:#666; font-size:0.9rem;">
                <span>by {{ r.user_name or 'Anonymous' }}</span>
                {% if r.created_at %}<span>¬∑ {{ r.created_at[:10] }}</span>{% endif %}
                <form method="post" action="{{ url_for('mark_review_helpful', rid=r.id) }}" style="margin-left:auto;">
                  <button type="submit" style="background:#f0fdf4; border:1px solid #c7eed8; color:#166534; padding:6px 10px; border-radius:8px; cursor:pointer;">üëç Helpful ({{ r.helpful_count }})</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div style="color:#666;">No reviews yet. Be the first to review this product.</div>
      {% endif %}

      <!-- Write a review -->
      <div style="margin-top: 1.5rem; border-top:1px solid #eee; padding-top: 1rem;">
        {% if session.get('user_logged_in') %}
          <h3 style="font-size:1.1rem; font-weight:700; margin-bottom:0.5rem;">Write a review</h3>
          <form method="post" action="{{ url_for('submit_review', pid=product.id) }}" style="display:grid; grid-template-columns: 1fr; gap:0.5rem; max-width: 640px;">
            <div>
              <label for="rating" style="display:block; color:#555; font-weight:600;">Rating</label>
              <select name="rating" id="rating" required style="padding:0.5rem; border:1px solid #ddd; border-radius:6px;">
                <option value="">Select rating</option>
                {% for i in range(5,0,-1) %}
                  <option value="{{ i }}">{{ i }} - {% for _ in range(i) %}‚òÖ{% endfor %}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label for="title" style="display:block; color:#555; font-weight:600;">Title (optional)</label>
              <input type="text" name="title" id="title" maxlength="120" placeholder="Great quality and fresh!" style="width:100%; padding:0.6rem; border:1px solid #ddd; border-radius:6px;">
            </div>
            <div>
              <label for="body" style="display:block; color:#555; font-weight:600;">Your review</label>
              <textarea name="body" id="body" rows="4" minlength="10" maxlength="2000" required placeholder="Share your experience..." style="width:100%; padding:0.6rem; border:1px solid #ddd; border-radius:6px;"></textarea>
            </div>
            <div>
              <button type="submit" class="btn btn-primary" style="width:auto;">Submit Review</button>
            </div>
          </form>
        {% else %}
          <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:1rem; border-radius:8px;">
            Please <a href="{{ url_for('user_login') }}">log in</a> to write a review.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
  function updateMainImage(button) {
    // Update main image from data-src
  const imagePath = button.dataset.src;
    const main = document.getElementById('mainImage') || document.getElementById('mainImageFallback');
    if (main && imagePath) main.src = imagePath;
    
    // Update active state
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    button.classList.add('active');
  }

  // Apply rating bar widths safely post-render
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.rating-bar-fill').forEach(function(el){
      var pct = Number.parseFloat(el.dataset.pct || '0');
      if (!Number.isNaN(pct)) {
        pct = Math.max(0, Math.min(100, pct));
        el.style.width = pct + '%';
      }
    });
  });
</script>

{% endblock %}
