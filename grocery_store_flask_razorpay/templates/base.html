<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="theme-color" content="#1f6feb">
  <meta name="description" content="{{ site_meta.description }}">
  <title>{{ title or site_meta.title }}</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}?v=5.10">
  <link rel="canonical" href="{{ (site_meta.base_url or request.url_root[:-1]) ~ request.path }}">
  <meta property="og:title" content="{{ title or site_meta.title }}">
  <meta property="og:description" content="{{ site_meta.description }}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ (site_meta.base_url or request.url_root[:-1]) ~ request.path }}">
  <meta property="og:image" content="{{ url_for('static', filename='favicon.svg', _external=True) }}">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ title or site_meta.title }}">
  <meta name="twitter:description" content="{{ site_meta.description }}">
  <script>
    // Prevent zoom and ensure viewport is respected on every page load
    document.addEventListener('DOMContentLoaded', function() {
      const viewport = document.querySelector('meta[name="viewport"]');
      if (viewport) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes');
      }
      // Reset any accidental zoom
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', function() {
          if (window.visualViewport.scale !== 1) {
            document.documentElement.style.zoom = 1;
          }
        });
      }
    });
  </script>
</head>
<body>
  {% if site_announcement %}
  <div class="topbar">
    <div class="container">{{ site_announcement }}</div>
  </div>
  {% endif %}
  <header style="overflow: visible;">
    <div class="container" style="position: relative;">
      
      <!-- ROW 1: Hamburger (Extreme Left) | Logo (Center) | Cart + User Info (Right) -->
      <div class="header-top-row" style="display: flex !important; align-items: center !important; justify-content: space-between !important; gap: 0.5rem !important; width: 100% !important; margin-bottom: 0.5rem !important; flex-wrap: nowrap !important;">
        
        <!-- Hamburger Menu Button - Extreme Left -->
        <button class="hamburger-toggle" id="hamburgerToggle" aria-label="Toggle menu" aria-expanded="false">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        
        <!-- Logo (Center/Flex-1) -->
        <h1 style="margin: 0 !important; flex: 1 !important; flex-shrink: 1 !important; min-width: 0 !important; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; order: 1 !important; text-align: center !important;"><a href="{{ url_for('reset_filters') }}">ğŸŒ± Organic Gut Point</a></h1>
        
        <!-- Right Section: Cart + User Info -->
        <div style="display: flex !important; align-items: center !important; gap: 0.5rem !important; flex-shrink: 0 !important; order: 2 !important; position: relative !important;">
          {% if session.get('admin_logged_in') or session.get('user_logged_in') %}
          <a href="{{ url_for('cart') }}" class="icon-button cart-icon-button" style="text-decoration: none !important;">ğŸ›’</a>
          {% endif %}
          
          <!-- User hover/tap menu next to cart (visible on desktop and mobile) -->
          <div class="user-menu" style="position: relative !important;">
            <button class="user-icon-button icon-button" aria-haspopup="true" aria-expanded="false" aria-label="User menu">
              ğŸ‘¤
            </button>
            <div class="user-popover hidden" role="menu" aria-label="User options">
              {% if session.get('admin_logged_in') %}
                <div class="user-popover-header">Admin: {{ session.get('admin_username') }}</div>
                <a role="menuitem" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
                <a role="menuitem" href="{{ url_for('admin_orders') }}">Orders</a>
                <a role="menuitem" href="{{ url_for('admin_logout') }}" class="logout">Logout</a>
              {% elif session.get('user_logged_in') %}
                <div class="user-popover-header">{{ session.get('user_name') }}</div>
                <a role="menuitem" href="{{ url_for('user_profile') }}">Profile</a>
                <a role="menuitem" href="{{ url_for('user_orders') }}">Orders</a>
                <a role="menuitem" href="{{ url_for('user_logout') }}" class="logout">Logout</a>
              {% else %}
                <a role="menuitem" href="{{ url_for('user_login') }}">Login</a>
                <a role="menuitem" href="{{ url_for('user_register') }}">Register</a>
              {% endif %}
            </div>
          </div>
          
        </div>
      </div>

      <!-- ROW 2: Navigation Menu -->
      <nav class="header-nav-primary" role="navigation" aria-label="Main navigation">
        {% if session.get('admin_logged_in') or session.get('user_logged_in') %}
        <div class="nav-account-block mobile-only">
          <div class="nav-user">
            <span class="user-emoji" aria-hidden="true">ğŸ‘¤</span>
            <span class="user-name">{{ session.get('admin_username') or session.get('user_name') }}</span>
          </div>
        </div>
        {% endif %}
  <a href="{{ url_for('reset_filters') }}" class="nav-item{% if request.endpoint == 'index' or request.endpoint == 'reset_filters' %} active{% endif %}">Home</a>
  <a href="{{ url_for('category_view', category='gutcare') }}" class="nav-item{% if request.endpoint == 'category_view' and request.view_args.get('category') == 'gutcare' %} active{% endif %}">ğŸŒ¿ Gut Care</a>
  <a href="{{ url_for('category_view', category='seasonal') }}" class="nav-item{% if request.endpoint == 'category_view' and request.view_args.get('category') == 'seasonal' %} active{% endif %}">ğŸ‚ Seasonal</a>
  <a href="{{ url_for('category_view', category='gutfeast') }}" class="nav-item{% if request.endpoint == 'category_view' and request.view_args.get('category') == 'gutfeast' %} active{% endif %}">ğŸ½ï¸ Gut Feast</a>
  <a href="{{ url_for('category_view', category='corporate') }}" class="nav-item{% if request.endpoint == 'category_view' and request.view_args.get('category') == 'corporate' %} active{% endif %}">ğŸ¢ Corporate</a>
  <a href="{{ url_for('category_view', category='gifts') }}" class="nav-item{% if request.endpoint == 'category_view' and request.view_args.get('category') == 'gifts' %} active{% endif %}">ğŸ Gifts</a>
  <a href="{{ url_for('community_home') }}" class="nav-item{% if request.endpoint == 'community_home' or 'community' in request.endpoint %} active{% endif %}">ğŸ’¬ Community</a>
        
        {% if session.get('admin_logged_in') %}
          <a href="{{ url_for('admin_products') }}" class="nav-item{% if 'admin_product' in request.endpoint %} active{% endif %}">ğŸ“¦ Products</a>
          <a href="{{ url_for('admin_subscribers') }}" class="nav-item{% if request.endpoint == 'admin_subscribers' %} active{% endif %}">Subscribers</a>
          <a href="{{ url_for('admin_catalog_images') }}" class="nav-item{% if request.endpoint == 'admin_catalog_images' %} active{% endif %}">Catalog</a>
        {% elif session.get('user_logged_in') %}
          {# Remove account links from main nav to avoid duplicates; available via user menu/drawer #}
        {% else %}
          {# Remove Login/Register from main nav; available via user menu/drawer #}
        {% endif %}
      </nav>
    </div>
    
    <!-- ROW 3: Search & Filters (Combined, Professional Layout) -->
    {% if request.endpoint in ('index', 'search') or 'index' in request.endpoint or 'search' in request.endpoint %}
    <div class="search-filters-container">
      <!-- Search Section -->
      <form class="search-box-wrapper" id="site-search-form-mobile" action="{{ url_for('search') }}" method="get" role="search" aria-label="Search products">
        <span class="search-icon">ğŸ”</span>
        <input 
          type="search" 
          id="search-input-mobile" 
          name="q" 
          placeholder="Search products, categories, keywords..." 
          aria-label="Search products" 
          value="{{ request.args.get('q','') }}" 
          class="search-input">
        <button type="reset" id="clearSearch" class="clear-btn" style="display: none;">âœ•</button>
      </form>

      <!-- Filters Section -->
      <div class="filters-wrapper">
        <!-- Product Origin Filter -->
        <form class="filter-form" action="{{ url_for('set_region') }}" method="post" aria-label="Choose product origin region">
          <label for="region_id" class="filter-label">ğŸŒ¾ Origin Region</label>
          <select id="region_id" name="region_id" onchange="this.form.submit()" class="filter-select">
            <option value="" {% if not current_region_id %}selected{% endif %}>ğŸš« None</option>
            <option value="all" {% if current_region_id == 'all' %}selected{% endif %}>ğŸ“ All Regions</option>
            <optgroup label="Karnataka Regions">
              {% for r in regions %}
              <option value="{{ r.id }}" {% if current_region_id == r.id %}selected{% endif %}>{{ r.name }}</option>
              {% endfor %}
            </optgroup>
          </select>
        </form>

        <!-- Status Filter -->
        <form class="filter-form" action="{{ url_for('set_product_status') }}" method="post" aria-label="Choose product status">
          <label for="product_status" class="filter-label">ğŸŒ± Status</label>
          <select id="product_status" name="product_status" onchange="this.form.submit()" class="filter-select">
            <option value="" {% if not current_product_status %}selected{% endif %}>ğŸš« None</option>
            <option value="all" {% if current_product_status == 'all' %}selected{% endif %}>ğŸ“Š All Status</option>
            <optgroup label="Harvest Status">
              <option value="Upcoming Harvest" {% if current_product_status == 'Upcoming Harvest' %}selected{% endif %}>â³ Upcoming Harvest</option>
              <option value="Harvest Complete" {% if current_product_status == 'Harvest Complete' %}selected{% endif %}>âœ… Harvest Complete</option>
              <option value="Final Product" {% if current_product_status == 'Final Product' %}selected{% endif %}>ğŸ“¦ Final Product</option>
            </optgroup>
          </select>
        </form>

        
      </div>
    </div>
    {% endif %}
  </header>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash">
      {% for category, message in messages %}
        <div class="flash-item {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
  {% endwith %}
  <script>
    // Auto-hide flash messages after 4 seconds
    document.addEventListener('DOMContentLoaded', function() {
      const flashDiv = document.querySelector('.flash');
      if (flashDiv) {
        setTimeout(() => {
          flashDiv.style.opacity = '0';
          flashDiv.style.transition = 'opacity 0.3s ease';
          setTimeout(() => {
            flashDiv.style.display = 'none';
          }, 300);
        }, 4000);
      }
      
      // ========== HAMBURGER MENU ==========
      const hamburger = document.getElementById('hamburgerToggle');
      const navMenu = document.querySelector('.header-nav-primary');
      
      if (hamburger && navMenu) {
        hamburger.addEventListener('click', () => {
          navMenu.classList.toggle('mobile-menu-open');
          hamburger.setAttribute('aria-expanded', navMenu.classList.contains('mobile-menu-open'));
        });
        
        // Close menu when a link is clicked
        navMenu.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            navMenu.classList.remove('mobile-menu-open');
            hamburger.setAttribute('aria-expanded', 'false');
          });
        });
      }

      // ========== USER MENU ICON (MOBILE + DESKTOP) ==========
      const userMenuBtn = document.querySelector('.user-icon-button');
      const userPopover = document.querySelector('.user-popover');
      
      if (userMenuBtn && userPopover) {
        userMenuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = userPopover.classList.contains('visible');
          if (isVisible) {
            userPopover.classList.remove('visible');
            userPopover.classList.add('hidden');
          } else {
            userPopover.classList.remove('hidden');
            userPopover.classList.add('visible');
          }
        });

        // Close popover when a link is clicked
        userPopover.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            userPopover.classList.remove('visible');
            userPopover.classList.add('hidden');
          });
        });

        // Close popover when clicking outside
        document.addEventListener('click', (e) => {
          if (!userMenuBtn.contains(e.target) && !userPopover.contains(e.target)) {
            userPopover.classList.remove('visible');
            userPopover.classList.add('hidden');
          }
        });
      }
      
    // Enhanced Search & Filters Experience
      const searchInput = document.getElementById('search-input-mobile');
      const clearBtn = document.getElementById('clearSearch');
      const searchForm = document.getElementById('site-search-form-mobile');
      
      // ========== SEARCH FUNCTIONALITY ==========
      if (searchInput && clearBtn) {
        // Show/hide clear button based on input
        const updateClearBtn = function() {
          clearBtn.style.display = searchInput.value.length > 0 ? 'block' : 'none';
        };
        
        // Initial check
        updateClearBtn();
        
        // Update on input
        searchInput.addEventListener('input', updateClearBtn);
        
        // Clear button click handler
        clearBtn.addEventListener('click', function(e) {
          e.preventDefault();
          searchInput.value = '';
          searchInput.focus();
          updateClearBtn();
          if (searchForm) {
            searchForm.submit();
          }
        });
      }
      
      // Debounced search (800ms after user stops typing)
      let searchTimeout;
      if (searchInput && searchForm) {
        searchInput.addEventListener('input', function() {
          clearTimeout(searchTimeout);
          if (this.value.length > 2) {
            searchTimeout = setTimeout(() => {
              searchForm.submit();
            }, 800);
          }
        });
      }
      
      // ========== FILTER INTERACTIONS ==========
      const filterSelects = document.querySelectorAll('.filter-select');
      
      filterSelects.forEach(select => {
        // Add focus styling
        select.addEventListener('focus', function() {
          this.style.borderColor = '#4caf50';
        });
        
        // Remove focus styling
        select.addEventListener('blur', function() {
          // Only reset if no change was made
          if (!this.changed) {
            this.style.borderColor = '#ddd';
          }
        });
        
        // Track changes
        select.addEventListener('change', function() {
          this.changed = true;
          this.style.borderColor = '#4caf50';
        });
      });
      
      // Filter section visibility toggle
      const isFilterPage = '{{ request.endpoint in ("index", "search") or "index" in request.endpoint or "search" in request.endpoint }}'.toLowerCase() === 'true';
      if (isFilterPage) {
        document.body.classList.add('filter-visible');
      }
    });
  </script>
  <main class="container">
    {% block content %}{% endblock %}
  </main>
  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <h4>About</h4>
          <p>Fresh organic groceries delivered fast. Quality you can trust.</p>
        </div>
        <div>
          <h4>Customer Care</h4>
          <ul>
            <li><a href="{{ url_for('customer_shipping') }}">Shipping & Delivery</a></li>
            <li><a href="{{ url_for('customer_returns') }}">Returns & Refunds</a></li>
            <li><a href="{{ url_for('customer_contact') }}">Contact</a></li>
          </ul>
        </div>
        <div>
          <h4>Newsletter</h4>
          <form action="{{ url_for('subscribe') }}" method="post" class="newsletter-form">
            <input type="email" name="email" placeholder="Your email" required>
            <button type="submit" class="btn">Subscribe</button>
          </form>
        </div>
      </div>
      <div class="footer-bottom">
        <span>Â© {{ site_meta.title }}</span>
        <div class="social-links">
          {% if whatsapp_number %}
          <a href="https://wa.me/{{ whatsapp_number | replace('+', '') }}" target="_blank" rel="noopener" title="Chat on WhatsApp" class="social-btn whatsapp">ğŸ’¬</a>
          {% endif %}
          <a href="https://www.instagram.com" target="_blank" rel="noopener" title="Follow on Instagram" class="social-btn">ğŸ“·</a>
          <a href="https://www.facebook.com" target="_blank" rel="noopener" title="Like on Facebook" class="social-btn">ğŸ‘</a>
          <a href="https://twitter.com" target="_blank" rel="noopener" title="Follow on Twitter" class="social-btn">ğ•</a>
        </div>
      </div>
    </div>
  </footer>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Store",
    "name": "{{ site_meta.title }}",
    "url": "{{ site_meta.base_url or request.url_root }}",
    "description": "{{ site_meta.description }}",
    "image": "{{ url_for('static', filename='favicon.svg', _external=True) }}"
  }
  </script>

  <dialog id="cookie-banner" class="cookie-banner" aria-label="Cookie Consent">
    <div class="container">
      <span>We use cookies to improve your experience. By using our site, you agree to our cookie policy.</span>
      <button id="cookie-accept" class="btn">Accept</button>
    </div>
  </dialog>
  <script>
    (function(){
      try {
        var key = 'og_cookie_consent';
        var dlg = document.getElementById('cookie-banner');
        if (dlg && !localStorage.getItem(key)) {
          if (typeof dlg.showModal === 'function') { dlg.showModal(); }
          else { dlg.setAttribute('open',''); }
        }
        var btn = document.getElementById('cookie-accept');
        if (btn) {
          btn.addEventListener('click', function(){
            localStorage.setItem(key, '1');
            var d = document.getElementById('cookie-banner');
            if (d && typeof d.close === 'function') { d.close(); }
            else { d.removeAttribute('open'); }
          });
        }
      } catch(e) {
        console.error('Cookie consent init failed:', e);
      }
    })();

    // Auto-submit search form when search input is cleared
    (function(){
      const searchInput = document.getElementById('search-input');
      const searchForm = document.getElementById('site-search-form');
      if (!searchInput || !searchForm) return;
      
      // Listen for the 'search' event (fired when user clicks the X button)
      searchInput.addEventListener('search', function(){
        // If input is empty (cleared), automatically submit the form
        if (this.value === '') {
          searchForm.submit();
        }
      });
    })();
  </script>
  <script>
    // Build background-image URLs for all catalog images
    document.addEventListener('DOMContentLoaded', function() {
      const leftSidebar = document.querySelector('.catalog-sidebar-left');
      const rightSidebar = document.querySelector('.catalog-sidebar-right');
      
      // Get image paths from the page (they're already in HTML data or we can build from template)
      // For now, just ensure background-image is applied
      if (leftSidebar && !leftSidebar.style.backgroundImage) {
        const bgImg = window.getComputedStyle(leftSidebar).backgroundImage;
        if (!bgImg || bgImg === 'none') {
          // Background image should be set in inline style or CSS
        }
      }
      if (rightSidebar && !rightSidebar.style.backgroundImage) {
        const bgImg = window.getComputedStyle(rightSidebar).backgroundImage;
        if (!bgImg || bgImg === 'none') {
          // Background image should be set in inline style or CSS
        }
      }
    });
  </script>
</body>
</html>
